{% extends "base.html" %}
{% block content %}

<h2>Tableau de bord</h2>

<!-- Formulaire de filtrage avanc√© -->
<form id="filters">
    <input type="text" id="search" placeholder="Rechercher un acte..." onkeyup="searchActes()">
    <br><br>
    
    <!-- Filtre par type d'acte -->
    <select id="type_acte" onchange="searchActes()">
        <option value="">Type d'acte</option>
        <option value="naissance">Acte de Naissance</option>
        <option value="mariage">Acte de Mariage</option>
        <option value="deces">Acte de D√©c√®s</option>
    </select>
    
    <!-- Filtre par date -->
    <input type="date" id="date_debut" onchange="searchActes()">
    <input type="date" id="date_fin" onchange="searchActes()">
    
    <!-- Filtre par agent responsable -->
    <input type="text" id="agent" placeholder="Agent responsable" onkeyup="searchActes()">
    <br><br>
    <button type="button" onclick="resetFilters()">R√©initialiser</button>
</form>

<!-- Indicateur de chargement -->
<div id="loader" style="display: none;">üîÑ Recherche en cours...</div>

<!-- Tableau des actes -->
<table>
    <thead>
        <tr>
            <th>Type</th>
            <th>Num√©ro</th>
            <th>Date d'enregistrement</th>
            <th>Agent Responsable</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="acte-list"></tbody>
</table>

<!-- Pagination -->
<div id="pagination" style="display: none;">
    <button onclick="prevPage()" id="prevBtn">‚¨ÖÔ∏è Pr√©c√©dent</button>
    <span id="page-number">Page 1</span>
    <button onclick="nextPage()" id="nextBtn">Suivant ‚û°Ô∏è</button>
</div>

<!-- Nombre total de r√©sultats -->
<p id="total-results"></p>

<!-- Script pour la recherche dynamique et la pagination -->
<script>
let currentPage = 1;
const itemsPerPage = 5;
let allResults = [];

function searchActes() {
    let query = document.getElementById("search").value;
    let typeActe = document.getElementById("type_acte").value;
    let dateDebut = document.getElementById("date_debut").value;
    let dateFin = document.getElementById("date_fin").value;
    let agent = document.getElementById("agent").value;

    document.getElementById("loader").style.display = "block";

    fetch(`/rechercher-actes/?q=${query}&type_acte=${typeActe}&date_debut=${dateDebut}&date_fin=${dateFin}&agent=${agent}`)
    .then(response => {
        if (!response.ok) {
            throw new Error("Erreur lors de la r√©cup√©ration des donn√©es.");
        }
        return response.json();
    })
    .then(data => {
        document.getElementById("loader").style.display = "none";
        if (data.results.length === 0) {
            document.getElementById("acte-list").innerHTML = "<tr><td colspan='5'>Aucun r√©sultat trouv√©.</td></tr>";
            document.getElementById("pagination").style.display = "none";
            document.getElementById("total-results").innerText = "";
        } else {
            allResults = data.results;
            currentPage = 1;
            renderTable();
        }
    })
    .catch(error => {
        document.getElementById("loader").style.display = "none";
        document.getElementById("acte-list").innerHTML = `<tr><td colspan='5' style='color: red;'>${error.message}</td></tr>`;
    });
}

function renderTable() {
    let tableBody = document.getElementById("acte-list");
    tableBody.innerHTML = "";
    let start = (currentPage - 1) * itemsPerPage;
    let end = start + itemsPerPage;
    let results = allResults.slice(start, end);

    results.forEach(acte => {
        let row = `<tr>
            <td>${acte.type}</td>
            <td>${acte.numero}</td>
            <td>${acte.date}</td>
            <td>${acte.agent}</td>
            <td>
                <a href="/acte/${acte.id}/">Voir</a>
                ${acte.document_pdf ? `<a href="/telecharger-acte/${acte.id}/">T√©l√©charger</a>` : ''}
            </td>
        </tr>`;
        tableBody.innerHTML += row;
    });

    document.getElementById("page-number").innerText = `Page ${currentPage}`;
    document.getElementById("total-results").innerText = `Total des r√©sultats : ${allResults.length}`;
    updatePagination();
}

function updatePagination() {
    let paginationDiv = document.getElementById("pagination");
    let prevBtn = document.getElementById("prevBtn");
    let nextBtn = document.getElementById("nextBtn");

    if (allResults.length <= itemsPerPage) {
        paginationDiv.style.display = "none";
    } else {
        paginationDiv.style.display = "flex";
    }

    prevBtn.disabled = (currentPage === 1);
    nextBtn.disabled = (currentPage * itemsPerPage >= allResults.length);
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        renderTable();
    }
}

function nextPage() {
    if (currentPage * itemsPerPage < allResults.length) {
        currentPage++;
        renderTable();
    }
}

function resetFilters() {
    document.getElementById("search").value = "";
    document.getElementById("type_acte").value = "";
    document.getElementById("date_debut").value = "";
    document.getElementById("date_fin").value = "";
    document.getElementById("agent").value = "";
    searchActes();
}

// Charger la liste initialement
searchActes();
</script>

<style>
    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #007bff;
        color: white;
    }

    tbody tr:nth-child(odd) {
        background-color: #f9f9f9;
    }

    tbody tr:hover {
        background-color: #f1f1f1;
    }

    input[type="text"], input[type="date"], select {
        padding: 8px;
        margin: 5px;
        border: 1px solid #ccc;
        width: 200px;
    }

    button {
        padding: 8px 12px;
        margin: 5px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
    }

    button:hover {
        background-color: #0056b3;
    }

    button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    #pagination {
        margin-top: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #loader {
        font-weight: bold;
        color: #007bff;
        margin-bottom: 10px;
    }

    #total-results {
        font-weight: bold;
        margin-top: 10px;
    }
</style>

{% endblock %}
